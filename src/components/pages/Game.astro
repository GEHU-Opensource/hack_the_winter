---
interface Props {
	class?: string;
}

const { class: className, ...props } = Astro.props;
---

<div
	id="matter-container"
	class:list={[
		"absolute bottom-0 left-0 right-0 w-full h-[120lvh]",
		className,
	]}
	{...props}
>
</div>

<div class="w-0 h-[120px] md:h-[200px] -z-1"></div>

<button
	id="matter-close"
	class="hidden fixed top-0 right-0 p-5 m-5 bg-gray-500/35 rounded-2xl z-5 cursor-pointer"
	>X</button
>

<script>
	import type { GameType } from "@/lib/game";

	let gameInstance: GameType;
	let initialized = false;

	async function startGame(container: HTMLElement) {
		if (initialized) return;
		initialized = true;

		const [{ default: Game }] = await Promise.all([
			import("@/lib/game"),
			// Yield to next frame to avoid blocking paint
			new Promise((r) => requestAnimationFrame(r)),
		]);

		gameInstance = new Game(container);
		gameInstance.run();

		// Debounced resize
		let resizeTimer: number | NodeJS.Timeout | undefined;
		window.addEventListener("resize", () => {
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(() => gameInstance?.resize(), 150);
		});
	}

	function attachInteractionBoost(
		container: HTMLElement,
		close: HTMLElement,
	) {
		container.style.zIndex = "";
		close.style.display = "none";

		const elevate = () => {
			container.style.zIndex = "2";
			close.style.display = "block";
			close.addEventListener(
				"click",
				() => {
					container.style.zIndex = "";
					close.style.display = "none";
					attachInteractionBoost(container, close);
				},
				{ once: true },
			);
		};

		container.addEventListener("mousedown", elevate, { once: true });
		container.addEventListener("touchstart", elevate, { once: true });
	}

	document.addEventListener("astro:page-load", () => {
		const container = document.getElementById("matter-container");
		const close = document.getElementById("matter-close");
		if (!container || !close) return;

		initialized = false;
		attachInteractionBoost(container, close);
		startGame(container);

		// Intersection gating
		const io = new IntersectionObserver(
			(entries) => {
				for (const entry of entries) {
					if (entry.isIntersecting) {
						if (gameInstance) {
							gameInstance.resume();
						} else {
							startGame(container);
						}
					} else {
						// Optionally pause if scrolled away
						gameInstance?.pause();
						container.style.zIndex = "";
						attachInteractionBoost(container, close);
					}
				}
			},
			{ root: null, threshold: 0.01 },
		);

		io.observe(container);
	});
</script>
